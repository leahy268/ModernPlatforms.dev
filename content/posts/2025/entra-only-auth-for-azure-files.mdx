---
title: "Cloud-Native Identity with Azure Files: A Game Changer for AVD & FSLogix"
date: "2025-12-01"
description: "Azure Files now supports Entra ID‚Äìonly authentication for SMB, removing the need for domain controllers and enabling fully cloud-native AVD architectures."
category: VDI
author: content/authors/warwick.md
excerpt: >
  Azure Files now supports Entra ID‚Äìonly authentication for SMB access, 
  eliminating the need for Active Directory. Learn how to enable Microsoft 
  Entra Kerberos authentication and configure folder permissions directly 
  in the Azure Portal for truly cloud-native AVD with FSLogix.
heroImage: "/images/blog/azure-files-entra-hero.png"
---

# Cloud-Native Identity with Azure Files: A Game Changer for AVD & FSLogix

Microsoft has released one of the most significant updates to Azure Virtual Desktop architecture in years:  
**Azure Files now supports Entra ID‚Äìonly authentication for SMB access (preview).**

This means FSLogix profiles hosted in Azure Files no longer require:

- Active Directory Domain Controllers  
- Azure AD Domain Services  
- Hybrid identity  
- NTLM/Kerberos authentication paths

This update unlocks *true* cloud-native AVD with zero Windows Servers.

---

## Why This Matters

Historically, FSLogix demanded a domain-joined identity backend for SMB access. Even in cloud-first AVD deployments, organizations were forced to maintain either Active Directory Domain Services or rely on Storage Account Keys as a workaround. The root causes were straightforward:

- SMB authentication depended on Kerberos or NTLM  
- Azure Files SMB only supported AD-backed identities  
- Session hosts required domain credentials to authenticate  

With this update, Azure Files can now authenticate SMB clients directly using **Entra ID OAuth tokens** ‚Äî completely eliminating the need for legacy directory services.

For AVD architects, this changes everything.

---

## What's New

Azure Files now supports:

- Entra ID‚Äìbased OAuth tokens for SMB  
- RBAC-based permissioning  
- No reliance on Kerberos or NTLM  
- Entra ID Joined VM support for FSLogix  
- Token-based access that aligns with Zero Trust principles  
- **Directory and file-level permissions configurable via the Azure Portal** (no more icacls from domain-joined machines!)

This is the first time Microsoft officially supports **FSLogix profiles on Azure Files without ANY AD**.

---

## Architecture: Before vs After

### ‚ùå Before: FSLogix on Azure Files (Traditional Model)

![Traditional FSLogix architecture with AD dependency](/uploads/Blogs/azure-files-architecture-before.png)
*Traditional architecture requiring domain controllers, Azure AD DS, or hybrid identity for FSLogix profile access.*

### ‚úÖ After: Cloud-Native FSLogix Using Entra ID Only (Preview)

![Cloud-native FSLogix architecture with Entra ID only](/uploads/Blogs/azure-files-architecture-after.png)
*Simplified cloud-native architecture: Entra joined session hosts authenticate directly to Azure Files via OAuth tokens.*

---

## How to Enable Microsoft Entra Kerberos Authentication

### Prerequisites

Before enabling Entra ID authentication, ensure you meet these requirements:

**For Cloud-Only Identities (Preview):**
- Windows 11 Enterprise/Pro (single or multi-session)
- Windows Server 2025 with latest cumulative updates
- Clients must be Microsoft Entra joined (not hybrid joined or AD-only)

**For Hybrid Identities:**
- Windows 11 Enterprise/Pro (single or multi-session)
- Windows 10 Enterprise/Pro, version 2004 or later with KB5007253
- Windows Server 2022/2025 with latest cumulative updates
- AD DS with Microsoft Entra Connect or Entra Connect cloud sync

**Important Considerations:**
- You can only use ONE identity source per storage account
- MFA must be disabled for the storage account's service principal
- The `WinHTTP Web Proxy Auto-Discovery Service` must be running
- The `IP Helper service (iphlpsvc)` must be running

### Step 1: Enable Microsoft Entra Kerberos in the Azure Portal

1. Sign in to the **Azure portal** and select your storage account
2. Under **Data storage**, select **File shares**
3. Next to **Identity-based access**, click the configuration status (e.g., "Not configured")
4. Under **Microsoft Entra Kerberos**, select **Set up**
5. Check the **Microsoft Entra Kerberos** checkbox
6. *(Optional for hybrid identities)* Enter your on-premises AD domain name and GUID if you want to configure permissions via Windows File Explorer
7. Click **Save**

### Step 2: Grant Admin Consent to the Service Principal

After enabling Entra Kerberos, a new application is automatically registered in your Entra tenant:

1. Open **Microsoft Entra ID** in the Azure portal
2. Navigate to **App registrations** ‚Üí **All Applications**
3. Find the application named: `[Storage Account] <your-storage-account-name>.file.core.windows.net`
4. Go to **API permissions**
5. Click **Grant admin consent for [Directory Name]** for the three requested permissions (openid, profile, User.Read)
6. Confirm with **Yes**

### Step 3: Enable Cloud-Only Groups Support (Required for Cloud-Only Identities)

For cloud-only identities, you must update the application manifest to support Entra-only group SIDs:

1. In the app registration, go to **Manifest**
2. Update the Tags to include the required cloud-only groups configuration
3. Save the manifest

> ‚ö†Ô∏è **Note:** Kerberos tickets have a maximum of 1,010 SIDs. Ensure your combined on-premises and cloud group SIDs don't exceed this limit.

### Step 4: Disable MFA for the Storage Account

Microsoft Entra Kerberos doesn't support MFA for file share access. You must exclude the storage account app from MFA conditional access policies:

1. In **Microsoft Entra ID**, go to **Security** ‚Üí **Conditional Access**
2. Edit your MFA policies
3. Add an exclusion for: `[Storage Account] <your-storage-account-name>.file.core.windows.net`

### Step 5: Assign Share-Level Permissions

Configure RBAC permissions to control who can access each file share:

- **Storage File Data SMB Share Reader** ‚Äì Read access
- **Storage File Data SMB Share Contributor** ‚Äì Read, write, delete access
- **Storage File Data SMB Share Elevated Contributor** ‚Äì Read, write, delete, modify ACLs

> üìù **For cloud-only identities:** You can only assign a default share-level permission that applies to all authenticated identities.

### Step 6: Configure Directory and File-Level Permissions (The Big Change! üéâ)

**This is the game-changer:** You can now configure NTFS-style directory and file-level permissions directly in the Azure Portal‚Äîno need for icacls commands or domain-joined machines!

For hybrid identities, you can still use Windows File Explorer from a domain-joined client if preferred, but the portal option removes this requirement for basic permission management.

> ‚ö†Ô∏è **Current Limitation:** Configuring directory and file-level permissions using Windows File Explorer isn't currently supported for cloud-only identities‚Äîuse the Azure Portal instead.

### Step 7: Configure Client Machines for Kerberos Ticket Retrieval

Enable cloud Kerberos ticket retrieval on each client machine using one of these methods:

**Via Intune:**
- Configure Policy CSP: `Kerberos/CloudKerberosTicketRetrievalEnabled` = `1`

**Via Group Policy:**
- Enable: `Administrative Templates > System > Kerberos > Allow retrieving the Azure AD Kerberos Ticket Granting Ticket during logon`

**Via Registry:**
```
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Kerberos\Parameters
CloudKerberosTicketRetrievalEnabled = 1 (DWORD)
```

# üîç Why This Is a Breakthrough for AVD

### 1. Removes AD Dependency
No more deploying and maintaining domain controllers or Azure AD Domain Services just for FSLogix. Your identity layer is fully managed by Microsoft Entra ID.

### 2. Enables Serverless AVD
Build complete AVD environments with zero Windows Server infrastructure. Session hosts, storage, and identity‚Äîall cloud-native PaaS/SaaS.

### 3. Simplifies Networking
Eliminate the need for site-to-site VPNs or ExpressRoute connections to on-premises AD. No more firewall rules for Kerberos/LDAP traffic.

### 4. Reduces Cost
- No domain controller VMs to run 24/7
- No Azure AD DS monthly fees (~$109+/month)
- Reduced networking costs
- Less operational overhead

### 5. Future Aligned (Zero Trust)
Token-based authentication with RBAC aligns perfectly with Zero Trust principles. No legacy protocols, no persistent credentials on the wire.

---

## üåç Regional Availability

**Hybrid Identities:** Available in Azure Public, Azure US Gov, and Azure China 21Vianet clouds.

**Cloud-Only Identities (Preview):** Currently available only in Azure Public cloud, limited to default share-level permissions for all authenticated identities.

---

## üìå Preview Limitations

Before diving in, be aware of these current limitations:

| Limitation | Details |
|------------|---------|
| **Windows Build Requirements** | Cloud-only requires Windows 11 or Server 2025; hybrid needs Win10 2004+ or Server 2022+ with specific KBs |
| **Single Identity Source** | You can't mix Entra Kerberos with AD DS or Entra Domain Services on the same storage account |
| **MFA Exclusion Required** | The storage account service principal must be excluded from MFA policies |
| **Cloud-Only RBAC** | Cloud-only identities can only use default share-level permissions (no per-user/group RBAC yet) |
| **File Explorer Permissions** | Configuring ACLs via Windows File Explorer isn't supported for cloud-only identities |
| **External Identity Limits** | FSLogix on AVD is supported for external B2B users, but cross-cloud guests are not |
| **Not Yet GA** | This is still in preview‚Äîexpect changes before general availability |  

---

## üß≠ What This Means for FSLogix

This update fundamentally changes how you can architect FSLogix profile storage:

| Old Requirement | New Reality |
|-----------------|-------------|
| AD DS domain controllers | ‚ùå Not required |
| Azure AD Domain Services | ‚ùå Not required |
| Hybrid domain join | ‚ùå Not required |
| On-premises network connectivity | ‚ùå Not required |
| Kerberos/NTLM protocols | ‚ùå Not required |

**What Works Today:**
- ‚úÖ FSLogix profile containers on Azure Files
- ‚úÖ MSIX App Attach from Azure Files
- ‚úÖ Entra ID joined session hosts
- ‚úÖ Cloud-only user accounts
- ‚úÖ Azure Portal-based ACL management

**Cross-Platform VDI Impact:**
While this announcement is most impactful for AVD, the underlying Azure Files capability benefits any VDI platform that supports Entra ID joined session hosts, including:
- Citrix DaaS (with Entra joined VDAs)
- VMware Horizon (with Entra joined desktops)
- Third-party VDI solutions

---

## üîß Troubleshooting

If you encounter issues, Microsoft provides a debugging cmdlet:

```powershell
# Install the AzFilesHybrid module (v0.3.0+)
Install-Module -Name AzFilesHybrid

# Run diagnostics
Debug-AzStorageAccountAuth -StorageAccountName "yourstorageaccount" -ResourceGroupName "yourRG"
```

This cmdlet performs basic checks on your Entra ID configuration and helps identify common misconfigurations.

**Common Issues:**
- Service principal password expired (for manual preview setups)
- MFA not properly excluded
- Missing admin consent on API permissions
- Client not configured for cloud Kerberos ticket retrieval

---

## üì£ Final Thoughts

This is the biggest identity improvement for AVD since Azure AD Join.  
For the first time, you can build a **100% cloud-native AVD environment without any Active Directory dependency**.

The ability to configure directory and file-level permissions directly in the Azure Portal is a massive quality-of-life improvement‚Äîno more spinning up domain-joined jump boxes just to run icacls commands.

**Next Steps:**
- [Enable Microsoft Entra Kerberos authentication](https://learn.microsoft.com/en-us/azure/storage/files/storage-files-identity-auth-hybrid-identities-enable)
- [Assign share-level permissions](https://learn.microsoft.com/en-us/azure/storage/files/storage-files-identity-assign-share-level-permissions)
- [Configure directory and file-level permissions](https://learn.microsoft.com/en-us/azure/storage/files/storage-files-identity-configure-file-level-permissions)
- [Create a profile container with Azure Files and Microsoft Entra ID](https://learn.microsoft.com/en-us/azure/virtual-desktop/create-profile-container-azure-ad)

If you're planning a greenfield AVD deployment or looking to modernize an existing environment, this preview is worth evaluating today.
