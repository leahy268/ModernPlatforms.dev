## 🧪 Why Test Bicep with Microsoft Symphony?

Infrastructure as Code (IaC) brings automation and consistency to cloud deployments, but testing can be a challenge. Bicep — Microsoft’s domain-specific language for Azure Resource Manager — simplifies infrastructure definitions. However, without proper validation, teams often encounter deployment issues that could have been caught earlier.

**This is where Microsoft Symphony shines.**  
Symphony orchestrates and executes workflows that automate validation, testing, and deployment of Bicep templates. Instead of waiting for a full deployment, you can run pre-deployment checks, validate parameters, and ensure everything is working before merging changes.

---

## ⚙️ Setting Up Symphony for Bicep Testing

### 1. Install Symphony and Dependencies

To get started, clone the Symphony repository and follow the setup instructions:

**Getting Started Guide**: https://github.com/microsoft/symphony/blob/main/docs/GETTING_STARTED.md

> 💡 On Windows, using **WSL** is recommended for ease of setup.

```bash
# Clone the Symphony repo
git clone https://github.com/microsoft/symphony.git && cd symphony

# Login to Azure
az login

# Set the target subscription
az account set --subscription <TargetSubscriptionId>

# Source the CLI setup
source setup.sh

# Deploy Symphony dependencies
symphony provision

# Configure the orchestrator (GitHub or Azure DevOps, with Bicep or Terraform)
symphony pipeline config <azdo|github> <terraform|bicep>
```

During setup, you’ll be prompted for:
- GitHub org and repo name  
- Whether the repo should be private  
- Whether to deploy private runners (**recommended**)  
- Resource group and subnet ID for runners  
- GitHub PAT for configuring secrets  
- Whether to install sample workflows (**yes!**)

> 🛡️ **Tip:** Installing private runners provides a safer space to test, especially if any secrets are accidentally exposed. GitHub-hosted runners had minor compatibility issues for me during setup.

---

## 🧪 PR Workflow: `workflow.pr.bicep.yaml`

This workflow is triggered when a **pull request to `main`** is opened, updated, or reopened. It automatically spins up a **temporary environment** to test infrastructure changes in isolation.

### 🛠️ What It Does

- Generates a unique environment name from a hash  
- Validates the Bicep templates  
- Stores environment metadata (commit SHA, name, etc.)  
- Deploys the base branch to simulate the current state  
- Overlays the PR branch to preview changes (`what-if`)  
- Runs integration or functional tests (if configured)  
- Automatically destroys the environment unless labeled to preserve it

### ✅ Why It Matters

This approach ensures changes are previewed and tested **before** merging into `main`. You get fast feedback, catch issues early, and avoid last-minute surprises in production.

---

## 🔄 Continuous Integration Workflow: `workflow.ci.bicep.yml`

This workflow supports **manual CI execution** using the `workflow_dispatch` trigger. It’s ideal for deploying to environments like **dev**, **test**, or **qa**.

### 🔧 Trigger

From the GitHub Actions UI, specify:
- `environmentName` (e.g., `dev`)  
- `locationName` (e.g., `australiaeast`)  

### 📋 What It Does

- Validates the Bicep templates  
- Runs a `what-if` to preview upcoming changes  
- Deploys the changes if validation passes  
- Executes tests in the deployed environment  

This gives you full control to test and deploy infrastructure changes as part of a structured CI process.

---

## ✅ Conclusion

Testing Bicep with Microsoft Symphony ensures issues are caught **early** in the development cycle. By automating validation, previewing changes, and testing before merging, Symphony empowers teams to ship infrastructure faster and safer — with fewer rollbacks and more confidence.

**Explore the Microsoft Symphony Repository:**  
https://github.com/microsoft/symphony

Start automating your IaC testing today.
